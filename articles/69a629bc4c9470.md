---
title: "tataku.vim ã¨ã„ã†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½œã£ã¦ã„ã‚‹è©±"
emoji: "ğŸ¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["vim", "neovim"]
publication_name: "vim_jp"
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯[Vim Advent Calendar 2022](https://qiita.com/advent-calendar/2022/vim)ã®12/11ã®è¨˜äº‹ã§ã™ã€‚
12/10ã¯[@higashi000](https://qiita.com/higashi000)ã•ã‚“ã®"[Neovimã§ãƒãƒ«ãƒãƒã‚¤ãƒˆã®æ–‡å­—ã‚’å«ã‚“ã è¡Œã®ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’å–å¾—ã—ã‚ˆã†](https://zenn.dev/higashi000/articles/get-charpos-in-neovim)"ã§ã—ãŸã€‚
:::

ã“ã“æ•°ã‹æœˆã€[tataku.vim](https://github.com/Omochice/tataku.vim)ã¨ã„ã†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½œã£ã¦ã„ã¾ã™ã€‚


## ãªãœã¤ãã£ãŸã‹

ç­†è€…ã¯ã“ã‚Œã¾ã§ã€[dps-translate-vim](https://github.com/Omochice/dps-translate-vim)ã‚„[dps-paiza-io-vim](https://github.com/Omochice/dps-paiza-io-vim)ãªã©ã®deno(denops.vim)ã‚’ä½¿ã£ã¦web apiã‚’å®Ÿè¡Œã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½œã£ã¦ãã¾ã—ãŸã€‚

ãã®ä¸­ã§ã€ä»¥ä¸‹ã®ç‚¹ãŒ"é¢å€’ã ãª"ã¨æ„Ÿã˜ã¾ã—ãŸã€‚

- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã”ã¨ã«ã„ã¡ã„ã¡ãƒãƒƒãƒ•ã‚¡ãªã©ã‹ã‚‰æ–‡å­—åˆ—ã‚’å–å¾—ã—ãªã‘ã‚Œã°ã„ã‘ãªã„
- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã”ã¨ã«ã„ã¡ã„ã¡ãƒãƒƒãƒ•ã‚¡ã«æ›¸ãå‡ºã™å‡¦ç†ã‚’æ›¸ã‹ãªã‘ã‚Œã°ã„ã‘ãªã„


è¦ã™ã‚‹ã«web apiã‚’*å©ã*éƒ¨åˆ†ãŒãƒ¡ã‚¤ãƒ³ãªã®ã«ã€ãã‚Œä»¥å¤–ã®éƒ¨åˆ†ã«æ°—ã‚’ä½¿ã‚ãªã„ã¨ã„ã‘ãªã„ã“ã¨ãŒæ°—ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚

ãã“ã§ã€å…¥åŠ›éƒ¨åˆ†ã¨å‡¦ç†éƒ¨åˆ†ã€å‡ºåŠ›éƒ¨åˆ†ã‚’åˆ†ã‘ã¦å®Ÿè£…ã§ãã‚‹ã‚ˆã†ãªä»•çµ„ã¿ã‚’ä½œã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚


## æ§‹æˆ

[tataku.vim](https://github.com/Omochice/tataku.vim)ã§ã¯(ä»Šã®ã¨ã“ã‚)å…¥åŠ›éƒ¨åˆ†ã‚’`collector`ã€å‡¦ç†éƒ¨åˆ†ã‚’`processor`ã€å‡ºåŠ›éƒ¨åˆ†ã‚’`emitter`ã¨å‘¼ã‚“ã§ã„ã¾ã™ã€‚

shellã®ã‚ˆã†ã«`collector | processor[0] | processor[1] ... | emitter`ã®ã‚ˆã†ãªæµã‚Œã§æ–‡å­—åˆ—ã‚’å‡¦ç†ã—ã¦ã„ãã‚¤ãƒ¡ãƒ¼ã‚¸ã§ä½œã£ã¦ã„ã¾ã™ã€‚

```mermaid
graph LR;
  collector-->processor0;
  processor0-->processor1;
  processor1-->emitter;
```

æµã‚Œã¦ã„ããƒ‡ãƒ¼ã‚¿ã®å‹ã¯Vimã‹ã‚‰å—ã‘å–ã‚‹æ–‡å­—åˆ—ã‚’æƒ³å®šã—ã¦ã„ã‚‹ãŸã‚ã€typescriptã§ã„ã†ã¨ã“ã‚ã®`string[]`ã«ãªã£ã¦ã„ã¾ã™ã€‚


## å®Ÿéš›ã«ä½¿ã†ã«ã¯

[tataku.vim](https://github.com/Omochice/tataku.vim)ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§`collector`ã€`processor`ã€`emitter`ã‚’å«ã‚“ã§ã„ãªã„ãŸã‚ã€å¿…è¦ãªã‚‚ã®ã¯åˆ¥é€”ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
(ã“ã®è¾ºã‚Šã¯[ddc.vim](https://github.com/Shougo/ddc.vim)ãªã©ã®dark-poweredãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å½±éŸ¿ã‚’å¼·ãå—ã‘ã¦ã„ã¾ã™ã€‚)

ä»Šã®ã¨ã“ã‚ã€ä»¥ä¸‹ã®ã‚‚ã®ãŒè‡ªåˆ†ã§ã¯å¿…è¦ã ã£ãŸã®ã§ä½œã£ã¦ã„ã¾ã™ã€‚

- [tataku-collector-current_line](https://github.com/Omochice/tataku-collector-current_line)
- [tataku-collector-lorem_ipsum](https://github.com/Omochice/tataku-collector-lorem_ipsum)(ãƒ†ã‚¹ãƒˆç”¨)
- [tataku-processor-deepl](https://github.com/Omochice/tataku-processor-deepl)
- [tataku-processor-google_translate](https://github.com/Omochice/tataku-processor-google_translate)
- [tataku-processor-intl_segmenter](https://github.com/Omochice/tataku-processor-intl_segmenter)
- [tataku-emitter-echo](https://github.com/Omochice/tataku-emitter-echo)
- [tataku-emitter-nvim_floatwin](https://github.com/Omochice/tataku-emitter-nvim_floatwin)
- [tataku-emitter-window](https://github.com/Omochice/tataku-emitter-window)

[tataku.vim](https://github.com/Omochice/tataku.vim)ã§ã¯`collector | processor[0] | processor[1] ... | emitter`ã®ã‚ˆã†ãªä¸€ã¤ã®æµã‚Œã‚’*Recipe*ã¨å‘¼ã‚“ã§ã„ã¾ã™ã€‚

ä¾‹ãˆã°ã€`ç¾åœ¨è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã‚’googleç¿»è¨³ã‚’ä½¿ã£ã¦è‹±èªã‹ã‚‰æ—¥æœ¬èªã«ç¿»è¨³ã—ã€echoã‚¨ãƒªã‚¢ã«å‡ºåŠ›ã™ã‚‹`ã¨ã„ã†Recipeã¯ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šã‚’æ›¸ãã“ã¨ã§å®Ÿç¾ã§ãã¾ã™ã€‚
([vim-plug](https://github.com/junegunn/vim-plug)å½¢å¼ã§æ›¸ã„ã¦ã„ã¾ã™ã€‚ã»ã‹ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ£ã®å ´åˆã¯é©å®œèª­ã¿æ›¿ãˆã¦ãã ã•ã„ã€‚)


```vim
Plug 'vim-denops/denops.vim'
Plug 'Omochice/tataku.vim'
Plug 'Omochice/tataku-collector-current_line'
Plug 'Omochice/tataku-processor-google_translate'
Plug 'Omochice/tataku-emitter-echo'

let g:tataku_recipes = #{
\  translate: #{
\    collector: #{ name: 'current_line', }, 
\    processor: [#{ name: 'google_translate', options: #{ source: 'en', target: 'ja' }}], 
\    collector: #{ name: 'echo' }, 
\  },
\}
```

ã“ã‚Œã§`translate`ã¨ã„ã†åå‰ã®RecipeãŒå®šç¾©ã•ã‚Œã¾ã—ãŸã€‚

å®šç¾©ã—ãŸRecipeã‚’å‘¼ã³å‡ºã™ãŸã‚ã«ã¯é–¢æ•°`tataku#call_recipe()`ã‚’ä½¿ã„ã¾ã™ã€‚

ã“ã®é–¢æ•°ã¯å¼•æ•°ã§Recipeã®åå‰ã‚’å–ã‚Šã¾ã™ã€‚

ä»Šå›ã®å ´åˆã€`translate`ã¨ã„ã†åå‰ã§Recipeã‚’å®šç¾©ã—ã¦ã„ã‚‹ã®ã§`tataku#call_recipe('translate')`ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€æ—¥æœ¬èªã«å¤‰æ›ã•ã‚ŒãŸç¾åœ¨è¡ŒãŒã‚¨ã‚³ãƒ¼ã‚¨ãƒªã‚¢ã«å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

### operatorã‚’ä½¿ã£ãŸãƒ¬ã‚·ãƒ”ã®å‘¼ã³å‡ºã—

å°‘ã—è„±ç·šã—ã¾ã™ãŒã€ç§ã¯Vimã¨ä»–ã®ã‚¨ãƒ‡ã‚£ã‚¿ã‚’æ¯”ã¹ãŸæ™‚ã€Vimã®å¼·ã¿ã«ãªã‚‹ã®ã¯*ãƒ¢ãƒ¼ãƒ‰*ã¨ã„ã†æ¦‚å¿µã¨ãã‚Œã‚’åŸºç¤ã¨ã™ã‚‹*operator*ã¨*textobject*ã®æ©Ÿèƒ½ã ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

ãã“ã§ã€[tataku.vim]()ã‚’operatorã¨ã—ã¦å‹•ä½œã•ã›ã‚‹æ–¹æ³•ã‚‚(æš«å®šçš„ã«ã€ã§ã™ãŒ)æä¾›ã—ã¦ã„ã¾ã™ã€‚

å¤‰æ•°`g:tataku_enable_operator`ã‚’`v:true`ã‹`1`ã«è¨­å®šã™ã‚‹ã¨ã€å®šç¾©ã—ãŸRecipeã‚’operatorã¨ã—ã¦ä½¿ã†ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€å…ˆè¿°ã—ãŸ`translate`ã®Recipeã§ã‚ã‚Œã°`<Plug>(operator-tataku-translate)`ã§operatorã¨ã—ã¦å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®ã¨ãã€Recipeå†…ã§å®šç¾©ã—ãŸ`collector`ã®å€¤ã¯ç„¡è¦–ã•ã‚Œã€`iw`ãªã©ã®textobjectã‚’å¯¾è±¡ã¨ã—ã¦Recipeã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

## processorã‚’è‡ªåˆ†ã§å®šç¾©ã™ã‚‹æ–¹æ³•

`collector`ã‚„`processor`ã€`emitter`ã‚’å®šç¾©ã™ã‚‹ã«ã¯ã€[tataku.vim]()ãŒå®šç¾©ã—ã¦ã„ã‚‹`Collector`ã‚„`Processor`ã€`Emitter`ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æº€ãŸã™ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€`['aaa', 'bbb', 'ccc']`ã‚’å—ã‘å–ã£ãŸæ™‚ã«ãã‚Œã‚’`['aaaaaa', 'bbbbbb', 'cccccc']`ã«ã™ã‚‹ã‚ˆã†ãª`processor`: `double`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã‘ã¾ã™ã€‚


```typescript
import { Processor } from "https://raw.githubusercontent.com/Omochice/tataku.vim/master/denops/tataku/interface.ts";
import { Denops } from "https://raw.githubusercontent.com/Omochice/tataku.vim/master/denops/tataku/deps.ts";
import {
  isObject,
  isString,
} from "https://deno.land/x/unknownutil@v2.0.0/mod.ts";

export default class implements Processor {
  constructor(private readonly option: Record<string, unknown>){
    if isOption(x) {
      throw new Error("option must has 'times' filed")
    }
  }

  async run(_: Denops, source: string[]) {
    return source.map((e: string) => e.repeat(this.option.times ?? 2))
  }
}

type Option = {
  times?: number
}

function isOption(x): x is Option {
  return isObject(x) && (isNumber(x.times) || isUndefined(x.times))
}
```

å®šç¾©ã—ãŸã‚¯ãƒ©ã‚¹ã‚’Vimã®runtimepathã®ä¸­ã®`@tataku/double.ts`ã§`default export`ã™ã‚‹ã“ã¨ã§`double`ã¨ã„ã†åå‰ã§tataku.vimã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã“ã®ã‚¯ãƒ©ã‚¹ã¯`run`ã¨ã„ã†åå‰ã®éåŒæœŸãªé–¢æ•°ã‚’æŒã¤å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã¾ãŸã€ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«ã¯Recipeã§è¨­å®šã—ãŸ`options`ã®å€¤ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚

`constructor()`ã‚„`run()`ã®ä¸­ã§`throw`ã—ãŸå ´åˆã€tataku.vimã¯ãã‚Œã‚’catchã—ã¦Recipeã®å®Ÿè¡Œã‚’æ­¢ã‚ã€ãƒ¦ãƒ¼ã‚¶ã«ã‚¨ãƒ©ãƒ¼å†…å®¹(ä»Šå›ã¯`"option must has 'times' filed"`)ã‚’ä¼ãˆã¾ã™ã€‚


## æœ€å¾Œã«

ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã¾ã é–‹ç™ºé€”ä¸­ãªã®ã§ã€ã‚‚ã—ã‹ã™ã‚‹ã¨Recipeã®å®šç¾©æ–¹æ³•ã‚„operatorã®ç™»éŒ²æ–¹æ³•ç­‰ãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

(operatorã¨ã—ã¦ã®ç™»éŒ²ãŒ all or nothingã«ãªã£ã¦ã—ã¾ã†ç‚¹ã‚„processorãªã©ã®å®šç¾©ã§`default export`ã‚’ä½¿ã‚ãªã„ã¨ã„ã‘ãªã„ã¨ã“ã‚ãªã©ã€å€‹äººçš„ã«ã‚‚ã«ã‚‡ã£ã¦ã„ã‚‹ã¨ã“ã‚ãŒå¤šã€…ã‚ã‚‹ã®ã§ã€æ°—ãŒå‘ã„ãŸã‚‰ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã™ã‚‹ã€ãã‚‰ã„ã®æ„å‘³ã§ã™ã€‚)
